<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Audio Editor</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="h-100 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | Audio Editor
      </h2>
    </div>

    <div class="row m-0 text-center text-white border-top border-info" style="height: 90vh; width: 100vw;">
      <div class="col-xl-7">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload Audio.</h1>
            <p class="lead">Upload your audio file. The preview will be available on the right.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>Audio Editor</h1>
            <p class="lead">Tweak any settings you want. Only the settings you modify will be applied.</p>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Audio Cropping</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-2">Start</label>
                <input id="startTimeBox" placeholder="0" type="text" class="ms-2 me-4 under-line measure-v" maxlength="4"/>
                <label for="saturationM" class="ms-4 me-2">End</label>
                <input id="endTimeBox" placeholder="5" type="text" class="ms-2 under-line measure-v" maxlength="4"/>
              </div>
            </div>
            <!--
            <div class="mb-3 text-start">
              <label for="pitchM" class="attached-text">Audio Pitch</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">0</label>
                <input id="pitchSlider" class="range-editor editor-b" type="range" min="-6" max="6" step="1" value="0" id="pitchM">
                <label for="saturationM" class="ms-4 me-2">15</label>
                <input id="pitchDisplayValue" placeholder="1000" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="0"/>
              </div>
            </div>
            -->
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Audio Speed</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">0.5</label>
                <input id="speedSlider" class="range-editor editor-b" type="range" min="0.5" max="2.5" step="0.25" value="1" id="speedM">
                <label for="saturationM" class="ms-4 me-2">2.5</label>
                <input id="speedDisplayValue" placeholder="1000" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
              </div>
            </div>
            <div class="mb-3 text-start" style="width: 40%;">
              <label for="saturationM" class="attached-text">Export Format</label>
              <div class="input-field-area">
                <div class="btn-group">
                  <button id="exportSelected" type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Extension
                  </button>
                  <ul class="dropdown-menu" style="background-color: #0dcaf0; color: white;">
                    <li><a class="dropdown-item selectable-extension" href="#">.mp3</a></li>
                    <!-- <li><a class="dropdown-item selectable-extension" href="#">.ogg</a></li> -->
                    <li><a class="dropdown-item selectable-extension" href="#">.wav</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5" id="containingBox" style="background-color: #06091f; padding: 50px !important;">
        <img id="imageDisplay" src="#" alt="Preview Image" class="visually-hidden m-auto" style="height: 60vh;"/>
        <h2>Audio Preview</h2>
        
        <div class="mt-4 mb-4 audio-player visually-hidden" id="audioPlayer">
            <div class="timeline">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="controls">
                <div class="play-container">
                    <div class="toggle-play play" id="playButton">
                    </div>
                </div>
                <div class="time">
                    <div class="current" id="audioOngoing">00:00</div>
                    <div class="divider">/</div>
                    <div class="length" id="audioLength">0:00</div>
                </div>
                <div class="name">Audio Player</div>
                <div class="volume-container">
                    <div class="volume-button">
                        <div class="volume icono-volumeMedium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16">
                                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                                <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                                <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="volume-slider">
                        <div class="volume-percentage"></div>
                    </div>
                </div>
            </div>
        </div>

        <a href="#">
          <button type="button" class="btn btn-outline-info" id="sendAudioCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Modify audio!
          </button>
        </a>
        <canvas width="500" height="500" id="realCanvas" class="visually-hidden"/>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      // Audio Editor - Section
      const startTimeDisplay = document.getElementById("startTimeBox");
      const endTimeDisplay = document.getElementById("endTimeBox");
      // const pitchSlider = document.getElementById("pitchSlider");
      // const pitchDisplayValue = document.getElementById("pitchDisplayValue");
      const speedSlider = document.getElementById("speedSlider");
      const speedDisplayValue = document.getElementById("speedDisplayValue")
      const exportSelected = document.getElementById("exportSelected");
      const extensions = document.getElementsByClassName("selectable-extension");

      // Important
      let maximumTime = 0;
      let minimumTime = 0;

      // APPLY LISTENERS
      for(let i = 0; i < extensions.length; i++)
        extensions[i].addEventListener("click", setExtension);
      speedSlider.addEventListener("change", updateSpeed);
      // //////////////////////////////////////////////////////////////////////////

      function setExtension(){
        exportSelected.innerText = this.innerText;
      }
      
      function updateSpeed(){
        speedDisplayValue.value = speedSlider.value;
      }
    </script>

    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const imageDisplay = document.getElementById("imageDisplay");

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", loadAudioFile, false);

      let audioObject = new Audio();

      function loadAudioFile(){
        let audioFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        
        audioObject = new Audio( URL.createObjectURL(audioFile) );
        audioObject.addEventListener('canplaythrough', audioLoaded, false);
        audioObject.load();
      }

      function audioLoaded(){
        displayElement(loader, false);
        displayElement(UID1, false);
        displayElement(UID2, true);
        displayElement(document.getElementById("audioPlayer"), true);
        maxDuration.innerText = ("0" + getMinutes(audioObject.duration)).slice(-2) + ":" + ("0" + getSeconds(audioObject.duration)).slice(-2);
        
        // Set variables
        maximumTime = Math.trunc(audioObject.duration);
        minimumTime = 0;

        startTimeDisplay.value = minimumTime;
        endTimeDisplay.value = maximumTime;
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>

    <script>
        // Audio player section
        const progressBar = document.getElementById("progressBar");
        const currentTime = document.getElementById("audioOngoing");
        const maxDuration = document.getElementById("audioLength");
        const playButtonA = document.getElementById("playButton");

        // Event listeners and routines and applications
        playButtonA.addEventListener("click", switchState);
        // /////////////////////////////////////////////////////

        // Control variables
        let isPlaying = false;
        // /////////////////////////////////////////////////////

        function progressUpdate(){
            if(!isPlaying)
                return;

            let progress = audioObject.currentTime / audioObject.duration;
            currentTime.innerText = ("0" + getMinutes(audioObject.currentTime)).slice(-2) + ":" + ("0" + getSeconds(audioObject.currentTime)).slice(-2);
            progressBar.style.width = (progress * 100) + "%";
            setTimeout(progressUpdate, 250);
        }

        function switchState(){
            if(isPlaying)
                pauseAudio()
            else
                playAudio()
        }

        // Utilities
        function playAudio(){
            isPlaying = true;
            audioObject.play();
            setTimeout(progressUpdate, 250);
        }

        function pauseAudio(){
            isPlaying = false;
            audioObject.pause();
        }

        function getMinutes(seconds){
            return Math.floor(seconds / 60);
        }

        function getSeconds(seconds){
            return Math.floor(seconds - getMinutes(seconds) * 60);
        }
    </script>

    <script>
      // Audio Communication - Server
      document.getElementById("sendAudioCall").addEventListener("click", sendAudioServer);

      function sendAudioServer(){
        let fileD = fileUpload.files[0];
        let formData = new FormData();
        formData.append("file", fileD);
        formData.append("extension", exportSelected.innerText == "Extension" ? ".mp3" : exportSelected.innerText)
        formData.append("speed", speedSlider.value)
        formData.append("startTime", startTimeDisplay.value)
        formData.append("endTime", endTimeDisplay.value)
        formData.append("DEFAULTSTART", minimumTime)
        formData.append("DEFAULTEND", maximumTime)

        // Send Request
        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", '/audioEditor', true);
        //httpRequest.setRequestHeader("Content-Type", "multipart/form-data");
        httpRequest.onreadystatechange = function(){ 
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                let jsonResponse = JSON.parse(this.responseText);
                let link = document.createElement("a");
                document.body.appendChild(link);
                link.setAttribute("type", "hidden");
                link.href = "data:text/plain;base64," + jsonResponse['musicFile'];
                link.download = "audioFile" + jsonResponse['extension'];
                link.click();
                document.body.removeChild(link);
                console.log("Terminated. Please, read from Server console to check the data sent.")
            }
        }
        httpRequest.send(formData);
      }
    </script>
</html>