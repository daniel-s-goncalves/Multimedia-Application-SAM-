<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Audio Editor</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="h-100 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | Audio Editor
      </h2>
    </div>

    <div class="row m-0 text-center text-white border-top border-info" style="height: 90vh; width: 100vw;">
      <div class="col-xl-7">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload Audio.</h1>
            <p class="lead">Upload your audio file. The preview will be available on the right.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>Audio Editor</h1>
            <p class="lead">Tweak any settings you want. Only the settings you have modified will apply.</p>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Audio Cropping</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-2">Start</label>
                <input placeholder="1000" type="text" class="ms-2 me-4 under-line measure-v disabled-l" maxlength="4"/>
                <label for="saturationM" class="ms-4 me-2">End</label>
                <input placeholder="1000" type="text" class="ms-2 under-line measure-v disabled-l" maxlength="4"/>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5" id="containingBox" style="background-color: #06091f; padding: 50px !important;">
        <img id="imageDisplay" src="#" alt="Preview Image" class="visually-hidden m-auto" style="height: 60vh;"/>
        <h2>Audio Preview</h2>
        
        <div class="mt-4 mb-4 audio-player visually-hidden" id="audioPlayer">
            <div class="timeline">
                <div class="progress" id="progressBar"></div>
            </div>
            <div class="controls">
                <div class="play-container">
                    <div class="toggle-play play" id="playButton">
                    </div>
                </div>
                <div class="time">
                    <div class="current" id="audioOngoing">0:00</div>
                    <div class="divider">/</div>
                    <div class="length" id="audioLength">0:00</div>
                </div>
                <div class="name">Audio Player</div>
                <div class="volume-container">
                    <div class="volume-button">
                        <div class="volume icono-volumeMedium">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-volume-up-fill" viewBox="0 0 16 16">
                                <path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/>
                                <path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/>
                                <path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.363-1.89a.5.5 0 0 1 .529-.06z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="volume-slider">
                        <div class="volume-percentage"></div>
                    </div>
                </div>
            </div>
        </div>

        <a href="#">
          <button type="button" class="btn btn-outline-info" id="storeImageCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Modify audio!
          </button>
        </a>
        <canvas width="500" height="500" id="realCanvas" class="visually-hidden"/>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const imageDisplay = document.getElementById("imageDisplay");

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", loadAudioFile, false);

      let audioObject = new Audio();

      function loadAudioFile(){
        let audioFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        
        audioObject = new Audio( URL.createObjectURL(audioFile) );
        audioObject.addEventListener('canplaythrough', audioLoaded, false);
        audioObject.load();
      }

      function audioLoaded(){
        displayElement(loader, false);
        displayElement(UID1, false);
        displayElement(UID2, true);
        displayElement(document.getElementById("audioPlayer"), true);
        maxDuration.innerText = getMinutes(audioObject.duration) + ":" + getSeconds(audioObject.duration);
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>

    <script>
        // Audio player section
        const progressBar = document.getElementById("progressBar");
        const currentTime = document.getElementById("audioOngoing");
        const maxDuration = document.getElementById("audioLength");
        const playButtonA = document.getElementById("playButton");

        // Event listeners and routines and applications
        playButtonA.addEventListener("click", switchState);
        // /////////////////////////////////////////////////////

        // Control variables
        let isPlaying = false;
        // /////////////////////////////////////////////////////

        function progressUpdate(){
            if(!isPlaying)
                return;

            let progress = audioObject.currentTime / audioObject.duration;
            currentTime.innerText = getMinutes(audioObject.currentTime) + ":" + getSeconds(audioObject.currentTime);
            progressBar.style.width = (progress * 100) + "%";
            setTimeout(progressUpdate, 250);
        }

        function switchState(){
            if(isPlaying)
                pauseAudio()
            else
                playAudio()
        }


        // Utilities

        function playAudio(){
            isPlaying = true;
            audioObject.play();
            setTimeout(progressUpdate, 250);
        }

        function pauseAudio(){
            isPlaying = false;
            audioObject.pause();
        }

        function getMinutes(seconds){
            return Math.floor(seconds / 60);
        }

        function getSeconds(seconds){
            return Math.floor(seconds - getMinutes(seconds) * 60);
        }
    </script>
</html>