<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>AudioCanary</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="h-100 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | GIF Editor
      </h2>
    </div>

    <div class="row m-0 text-center text-white border-top border-info" style="height: 90vh; width: 100vw;">
      <div class="col-xl-7">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload GIF</h1>
            <p class="lead">Upload your animated image. The preview will be available on the right.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>GIF Editor</h1>
            <p class="lead">Tweak any settings you want. Only the settings you modify will be applied.</p>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">GIF Frame Speed</label>
              <div class="input-field-area" style="justify-content: start !important;">
                <label for="saturationM" class="me-4">0.5</label>
                <input id="speedM" class="range-editor editor-b" type="range" min="0.5" max="2" step="0.1" value="1">
                <label for="saturationM" class="ms-4 me-2">2</label>
                <input id="speedDisplayValue" placeholder="1" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
              </div>
            </div>

            <!--
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Compress Level</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">0</label>
                <input id="compressLevelM" class="range-editor editor-b" type="range" min="0" max="15" step="1" value="0">
                <label for="saturationM" class="ms-4 me-2">15</label>
                <input id="compressLevelDisplayValue" placeholder="0" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="0"/>
              </div>
            </div>
          -->

            <div class="mb-3 text-start" style="width: 50%;">
              <label for="saturationM" class="attached-text">Animation Flow</label>
              <div class="input-field-area d-flex justify-content-between">
                <label for="saturationM" class="me-1 fs-5 checker-input">Reverse</label>
                <label class="switch">
                  <input id="reverseM" type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>

            <div class="mb-3 text-start" style="width: 50%;">
              <div class="input-field-area d-flex justify-content-between">
                <label for="saturationM" class="me-1 fs-5 checker-input">Loopback</label>
                <label class="switch">
                  <input id="loopbackM" type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>   
            
            <div class="mb-3 text-start" style="width: 50%;">
              <label for="saturationM" class="attached-text">Misc</label>
              <div class="input-field-area d-flex justify-content-between">
                <label for="saturationM" class="me-1 fs-5 checker-input">Extract Frames</label>
                <label class="switch">
                  <input id="enableExtractM" type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>   
          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5" id="containingBox" style="background-color: #06091f; padding: 50px !important;">
        <h2>GIF Preview</h2>
        
        <div class="mt-4 mb-4 gif-display visually-hidden" id="gifDisplayBox">
            <img id="imageDisplay" src="gggg"/>
        </div>

        <a href="#">
          <button type="button" class="btn btn-outline-info" id="sendGIFCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Modify GIF
          </button>
        </a>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>

    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const gifBoxSection = document.getElementById("gifDisplayBox");
      const gifPreview = document.getElementById("imageDisplay");

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", loadGIFFile, false);

      let gifReader = new FileReader();

      function loadGIFFile(){
        let gifFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)

        // Apply Data
        gifPreview.title = gifFile.name;
        gifReader.onload = function(event){
          gifPreview.src = event.target.result;
          displayElement(gifBoxSection, true);
          displayElement(loader, false);
          displayElement(UID1, false);
          displayElement(UID2, true);
        };
        gifReader.readAsDataURL(gifFile);
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>

    <script>
      // Input Components
      const frameSpeedO = document.getElementById("speedM");
      const frameSpeedDisplayO = document.getElementById("speedDisplayValue");
      //const compressLevelO = document.getElementById("compressLevelM");
      //const compressLevelDisplayO = document.getElementById("compressLevelDisplayValue");

      // Checkers
      const reverseO = document.getElementById("reverseM");
      const loopbackO = document.getElementById("loopbackM");
      const extractSwitchO = document.getElementById("enableExtractM");
      const checkFiltersO = document.getElementsByClassName("check-filter");

      // Event Listeners::
      frameSpeedO.addEventListener("input", function(){ frameSpeedDisplayO.value = frameSpeedO.value; })
      //compressLevelO.addEventListener("input", function(){ compressLevelDisplayO.value = compressLevelO.value; })
      for(let i = 0; i < checkFiltersO.length; i++)
        checkFiltersO[i].addEventListener("click", filterProcess)
      checkFiltersO[2].addEventListener("click", handleExtraction)

      function filterProcess(event){
        if(!event.target.checked)
          return;
        for(let i = 0; i < checkFiltersO.length; i++){
          if(checkFiltersO[i] !== event.target)
            checkFiltersO[i].checked = false;
        }
      }

      function handleExtraction(event){
        enableElement(frameSpeedO, !event.target.checked)
      }
    </script>

    <script>
      // Audio Communication - Server
      document.getElementById("sendGIFCall").addEventListener("click", sendGIFServer);

      function sendGIFServer(){
        let fileD = fileUpload.files[0];
        let formData = new FormData();
        formData.append("file", fileD);
        formData.append("framespeed", frameSpeedO.value)
        //formData.append("optimizationLevel", compressLevelO.value)
        formData.append("shouldReverse", reverseO.checked)
        formData.append("shouldLoopback", loopbackO.checked)
        formData.append("shouldExtractFrames", extractSwitchO.checked)

        // Send Request
        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", '/gifEditor', true);
        //httpRequest.setRequestHeader("Content-Type", "multipart/form-data");
        httpRequest.onreadystatechange = function(){ 
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                let jsonResponse = JSON.parse(this.responseText);
                let link = document.createElement("a");
                document.body.appendChild(link);
                link.setAttribute("type", "hidden");
                link.href = "data:text/plain;base64," + jsonResponse['imageFile'];
                link.download = "result" + jsonResponse['extension'];
                link.click();
                document.body.removeChild(link);
                console.log("Terminated. Please, read from Server console to check the data sent.")
            }
        }
        httpRequest.send(formData);
      }
    </script>
</html>