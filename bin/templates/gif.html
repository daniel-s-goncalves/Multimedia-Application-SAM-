{% extends "base.html" %}

{% block complementaryTitle %}| GIF Editor{% endblock %}

{% block head %}  {% endblock %}

{% block pagetype %}GIF Editor{% endblock %}
{% block pagetitles %}GIF Editor{% endblock %}

{% block uploadTitle %}Upload Animated Image{% endblock %}

{% block uploadMessage %}After the upload we will display a real-time preview {% endblock %}

{% block inputBox %}
  <input class="form-control" style="width: 15rem; margin: auto;" type="file" id="fileUpload" accept=".gif">
{% endblock %}

{% block editingFeatures %}

  <div class="mb-3 text-start">
    <div class="field-button d-flex justify-content-between align-items-center">
      <label>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-wind me-2" viewBox="0 0 16 16">
          <path d="M12.5 2A2.5 2.5 0 0 0 10 4.5a.5.5 0 0 1-1 0A3.5 3.5 0 1 1 12.5 8H.5a.5.5 0 0 1 0-1h12a2.5 2.5 0 0 0 0-5zm-7 1a1 1 0 0 0-1 1 .5.5 0 0 1-1 0 2 2 0 1 1 2 2h-5a.5.5 0 0 1 0-1h5a1 1 0 0 0 0-2zM0 9.5A.5.5 0 0 1 .5 9h10.042a3 3 0 1 1-3 3 .5.5 0 0 1 1 0 2 2 0 1 0 2-2H.5a.5.5 0 0 1-.5-.5z"/>
        </svg>
        Frame Speed
      </label>
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
      </svg>
    </div>
    <div class="collapse">
      <div class="settings-box">
        <div class="input-field-area" style="justify-content: start !important;">
          <label class="me-4">0.5</label>
          <input id="speedM" class="range-editor editor-b" type="range" min="0.5" max="2" step="0.1" value="1">
          <label class="ms-4 me-2">2</label>
          <input id="speedDisplayValue" placeholder="1" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
        </div>
        <label class="attached-text mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
          Set up the delay of each frame.
        </label>
      </div>
    </div>
  </div>

  <div class="mb-3 text-start">
    <div class="field-button d-flex justify-content-between align-items-center">
      <label>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-fan me-2" viewBox="0 0 16 16">
          <path d="M10 3c0 1.313-.304 2.508-.8 3.4a1.991 1.991 0 0 0-1.484-.38c-.28-.982-.91-2.04-1.838-2.969a8.368 8.368 0 0 0-.491-.454A5.976 5.976 0 0 1 8 2c.691 0 1.355.117 1.973.332.018.219.027.442.027.668Zm0 5c0 .073-.004.146-.012.217 1.018-.019 2.2-.353 3.331-1.006a8.39 8.39 0 0 0 .57-.361 6.004 6.004 0 0 0-2.53-3.823 9.02 9.02 0 0 1-.145.64c-.34 1.269-.944 2.346-1.656 3.079.277.343.442.78.442 1.254Zm-.137.728a2.007 2.007 0 0 1-1.07 1.109c.525.87 1.405 1.725 2.535 2.377.2.116.402.222.605.317a5.986 5.986 0 0 0 2.053-4.111c-.208.073-.421.14-.641.199-1.264.339-2.493.356-3.482.11ZM8 10c-.45 0-.866-.149-1.2-.4-.494.89-.796 2.082-.796 3.391 0 .23.01.457.027.678A5.99 5.99 0 0 0 8 14c.94 0 1.83-.216 2.623-.602a8.359 8.359 0 0 1-.497-.458c-.925-.926-1.555-1.981-1.836-2.96-.094.013-.191.02-.29.02ZM6 8c0-.08.005-.16.014-.239-1.02.017-2.205.351-3.34 1.007a8.366 8.366 0 0 0-.568.359 6.003 6.003 0 0 0 2.525 3.839 8.37 8.37 0 0 1 .148-.653c.34-1.267.94-2.342 1.65-3.075A1.988 1.988 0 0 1 6 8Zm-3.347-.632c1.267-.34 2.498-.355 3.488-.107.196-.494.583-.89 1.07-1.1-.524-.874-1.406-1.733-2.541-2.388a8.363 8.363 0 0 0-.594-.312 5.987 5.987 0 0 0-2.06 4.106c.206-.074.418-.14.637-.199ZM8 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z"/>
          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14Zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16Z"/>
        </svg>
        Animation Flow
      </label>
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
      </svg>
    </div>
    <div class="collapse">
      <div class="settings-box">
        <div class="input-field-area" style="justify-content: start !important;">
          <label for="saturationM" class="me-1 fs-5 checker-input">Reverse</label>
          <label class="switch">
            <input id="reverseM" type="checkbox" class="check-filter">
            <span class="slider round"></span>
          </label>
        </div>
        <div class="input-field-area" style="justify-content: start !important;">
          <label for="saturationM" class="me-1 fs-5 checker-input">Loopback</label>
          <label class="switch">
            <input id="loopbackM" type="checkbox" class="check-filter">
            <span class="slider round"></span>
          </label>
        </div>
        <label class="attached-text mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
          Set up the delay of each frame.
        </label>
      </div>
    </div>
  </div>

  <div class="mb-3 text-start">
    <div class="field-button d-flex justify-content-between align-items-center">
      <label>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-break me-2" viewBox="0 0 16 16">
          <path d="M0 10.5a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5zM12 0H4a2 2 0 0 0-2 2v7h1V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v7h1V2a2 2 0 0 0-2-2zm2 12h-1v2a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1v-2H2v2a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-2z"/>
        </svg>
        Misc
      </label>
      <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
      </svg>
    </div>
    <div class="collapse">
      <div class="settings-box">
        <div class="input-field-area" style="justify-content: start !important;">
          <label class="me-1 fs-5 checker-input">Extract Frames</label>
          <label class="switch">
            <input id="enableExtractM" type="checkbox" class="check-filter">
            <span class="slider round"></span>
          </label>
        </div>
        <label class="attached-text mt-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
          </svg>
          This will disable all other settings.
        </label>
      </div>
    </div>
  </div>
{% endblock %}

{% block previewTitle %}GIF Preview{% endblock %}

{% block previewElements %}
  <div class="mt-4 mb-4 gif-display visually-hidden" id="gifDisplayBox">
    <img id="imageDisplay" src="gggg"/>
  </div>
{% endblock %}

{% block previewButtons %}
  <a href="#">
    <button type="button" class="btn btn-outline-info" id="sendGIFCall">
      <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
      Modify GIF
    </button>
  </a>
{% endblock %}

{% block scripts %}
<script>
  const fileUpload = document.getElementById("fileUpload");
  const loader = document.getElementById("loadingView");
  const gifBoxSection = document.getElementById("gifDisplayBox");
  const gifPreview = document.getElementById("imageDisplay");

  const UID1 = document.getElementById("mainBox");
  const UID2 = document.getElementById("editBox");
  fileUpload.addEventListener("change", loadGIFFile, false);

  let gifReader = new FileReader();

  function loadGIFFile(){
    let gifFile = this.files[0];
    displayElement(fileUpload, false)
    displayElement(loader, true)

    // Apply Data
    gifPreview.title = gifFile.name;
    gifReader.onload = function(event){
      gifPreview.src = event.target.result;
      displayElement(gifBoxSection, true);
      displayElement(loader, false);
      displayElement(UID1, false);
      displayElement(UID2, true);
      adjustApplication();
    };
    gifReader.readAsDataURL(gifFile);
  }

  function displayElement(element, showOnScreen){
    if(showOnScreen)
      element.classList.remove("visually-hidden");
    else
      element.classList.add("visually-hidden");
  }

  function enableElement(element, enable){
    if(enable)
      element.classList.remove("disabled-l");
    else
      element.classList.add("disabled-l");
  }
</script>

<script>
  // Input Components
  const frameSpeedO = document.getElementById("speedM");
  const frameSpeedDisplayO = document.getElementById("speedDisplayValue");
  //const compressLevelO = document.getElementById("compressLevelM");
  //const compressLevelDisplayO = document.getElementById("compressLevelDisplayValue");

  // Checkers
  const reverseO = document.getElementById("reverseM");
  const loopbackO = document.getElementById("loopbackM");
  const extractSwitchO = document.getElementById("enableExtractM");
  const checkFiltersO = document.getElementsByClassName("check-filter");

  // Event Listeners::
  frameSpeedO.addEventListener("input", function(){ frameSpeedDisplayO.value = frameSpeedO.value; })
  //compressLevelO.addEventListener("input", function(){ compressLevelDisplayO.value = compressLevelO.value; })
  for(let i = 0; i < checkFiltersO.length; i++)
    checkFiltersO[i].addEventListener("click", filterProcess)
  checkFiltersO[2].addEventListener("click", handleExtraction)

  function filterProcess(event){
    if(!event.target.checked)
      return;
    for(let i = 0; i < checkFiltersO.length; i++){
      if(checkFiltersO[i] !== event.target)
        checkFiltersO[i].checked = false;
    }
  }

  function handleExtraction(event){
    enableElement(frameSpeedO, !event.target.checked)
  }
</script>

<script>
  // Audio Communication - Server
  document.getElementById("sendGIFCall").addEventListener("click", sendGIFServer);

  function sendGIFServer(){
    displayElement(document.getElementsByClassName("loading-save")[0], true);
    document.getElementById("sendGIFCall").classList.add("disabled");

    let fileD = fileUpload.files[0];
    let formData = new FormData();
    formData.append("file", fileD);
    formData.append("framespeed", frameSpeedO.value)
    //formData.append("optimizationLevel", compressLevelO.value)
    formData.append("shouldReverse", reverseO.checked)
    formData.append("shouldLoopback", loopbackO.checked)
    formData.append("shouldExtractFrames", extractSwitchO.checked)

    // Send Request
    var httpRequest = new XMLHttpRequest();
    httpRequest.open("POST", '/gifEditor', true);
    //httpRequest.setRequestHeader("Content-Type", "multipart/form-data");
    httpRequest.onreadystatechange = function(){ 
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
            let jsonResponse = JSON.parse(this.responseText);
            let link = document.createElement("a");
            document.body.appendChild(link);
            link.setAttribute("type", "hidden");
            link.href = "data:text/plain;base64," + jsonResponse['imageFile'];
            link.download = "result" + jsonResponse['extension'];
            link.click();

            displayElement(document.getElementsByClassName("loading-save")[0], false);
            document.getElementById("sendGIFCall").classList.remove("disabled");
            document.body.removeChild(link);
            console.log("Terminated. Please, read from Server console to check the data sent.")
        }
    }
    httpRequest.send(formData);
  }
</script>
{% endblock %}