<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Video Editor</title>
      <!-- Bootstrap core CSS -->
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="h-100 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | Video Editor
      </h2>
    </div>

    <div class="row m-0 text-center text-white border-top border-info flex-nowrap" style="height: 90vh; width: 100vw;">
      <div class="col-xl-12 fully-animated overflow-auto" id="uploadBox">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload Video.</h1>
            <p class="lead">Upload your video file. The preview will be available on the right.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>Video Editor</h1>
            <p class="lead">Tweak any settings you want. Only the settings you modify will be applied.</p>
            
            <h5 style="margin-top: 10%;">Video Settings</h5>
            <div class="mb-3 text-start">
              <div class="field-button d-flex justify-content-between align-items-center">
                <label>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-film me-2" viewBox="0 0 16 16">
                    <path d="M0 1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V1zm4 0v6h8V1H4zm8 8H4v6h8V9zM1 1v2h2V1H1zm2 3H1v2h2V4zM1 7v2h2V7H1zm2 3H1v2h2v-2zm-2 3v2h2v-2H1zM15 1h-2v2h2V1zm-2 3v2h2V4h-2zm2 3h-2v2h2V7zm-2 3v2h2v-2h-2zm2 3h-2v2h2v-2z"/>
                  </svg>
                  Video Time Cropping
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
              <div class="collapse">
                <div class="input-field-area">
                  <div>
                    <label class="me-1">Start</label>
                    <input id="startCropM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                  <div>
                    <label class="me-1">End</label>
                    <input id="endCropM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3 text-start">
              <div class="field-button d-flex justify-content-between align-items-center">
                <label>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-arrows-expand me-2" viewBox="0 0 16 16" style="transform: rotate(90deg);">
                    <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13A.5.5 0 0 1 1 8zM7.646.146a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 1.707V5.5a.5.5 0 0 1-1 0V1.707L6.354 2.854a.5.5 0 1 1-.708-.708l2-2zM8 10a.5.5 0 0 1 .5.5v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 14.293V10.5A.5.5 0 0 1 8 10z"/>
                  </svg>
                  Video Fade Effect
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
              <div class="collapse" >
                <div class="input-field-area">
                  <div>
                    <label class="me-1">Fade In</label>
                    <input id="startFadeM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                  <div>
                    <label class="me-1">Fade Out</label>
                    <input id="endFadeM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3 text-start">
              <div class="field-button d-flex justify-content-between align-items-center">
                <label>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-speedometer2 me-2" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5V6a.5.5 0 0 1-1 0V4.5A.5.5 0 0 1 8 4zM3.732 5.732a.5.5 0 0 1 .707 0l.915.914a.5.5 0 1 1-.708.708l-.914-.915a.5.5 0 0 1 0-.707zM2 10a.5.5 0 0 1 .5-.5h1.586a.5.5 0 0 1 0 1H2.5A.5.5 0 0 1 2 10zm9.5 0a.5.5 0 0 1 .5-.5h1.5a.5.5 0 0 1 0 1H12a.5.5 0 0 1-.5-.5zm.754-4.246a.389.389 0 0 0-.527-.02L7.547 9.31a.91.91 0 1 0 1.302 1.258l3.434-4.297a.389.389 0 0 0-.029-.518z"/>
                    <path fill-rule="evenodd" d="M0 10a8 8 0 1 1 15.547 2.661c-.442 1.253-1.845 1.602-2.932 1.25C11.309 13.488 9.475 13 8 13c-1.474 0-3.31.488-4.615.911-1.087.352-2.49.003-2.932-1.25A7.988 7.988 0 0 1 0 10zm8-7a7 7 0 0 0-6.603 9.329c.203.575.923.876 1.68.63C4.397 12.533 6.358 12 8 12s3.604.532 4.923.96c.757.245 1.477-.056 1.68-.631A7 7 0 0 0 8 3z"/>
                  </svg>
                  Change video speed
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
              <div class="collapse" >
                <div class="input-field-area">
                  <label class="me-4">0.5</label>
                  <input id="speedSlider" class="range-editor editor-b" type="range" min="0.5" max="2.5" step="0.25" value="1" id="speedM">
                  <label fclass="ms-4 me-2">2.5</label>
                  <input id="speedDisplayValue" placeholder="1000" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
                </div>
              </div>
            </div>

            <div class="mb-3 text-start">
              <div class="field-button d-flex justify-content-between align-items-center">
                <label>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-aspect-ratio me-2" viewBox="0 0 16 16">
                    <path d="M0 3.5A1.5 1.5 0 0 1 1.5 2h13A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5v-9zM1.5 3a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-13z"/>
                    <path d="M2 4.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1H3v2.5a.5.5 0 0 1-1 0v-3zm12 7a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1 0-1H13V8.5a.5.5 0 0 1 1 0v3z"/>
                  </svg>
                  Change video resolution
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
              <div class="collapse" >
                <div class="input-field-area">
                  <label class="me-4">0.25</label>
                  <input id="scaleSlider" class="range-editor editor-b" type="range" min="0.25" max="1" step="0.05" value="1">
                  <label class="ms-4 me-2">1</label>
                  <input id="scaleDisplayValue" placeholder="1000" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
                </div>
              </div>
            </div>

            <h5 style="margin-top: 10%;">Audio Settings</h5>
            <div class="mb-3 text-start">
              <div class="field-button d-flex justify-content-between align-items-center">
                <label>
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-soundwave me-2" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8.5 2a.5.5 0 0 1 .5.5v11a.5.5 0 0 1-1 0v-11a.5.5 0 0 1 .5-.5zm-2 2a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm4 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm-6 1.5A.5.5 0 0 1 5 6v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm8 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm-10 1A.5.5 0 0 1 3 7v2a.5.5 0 0 1-1 0V7a.5.5 0 0 1 .5-.5zm12 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0V7a.5.5 0 0 1 .5-.5z"/>
                  </svg>
                  Audio fading effect
                </label>
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                </svg>
              </div>
              <div class="collapse">
                <div class="input-field-area">
                  <div>
                    <label class="me-1">Fade In</label>
                    <input id="startFadeM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                  <div>
                    <label class="me-1">Fade Out</label>
                    <input id="endFadeM" placeholder="0" type="text" class="text-input measure-v ms-1" maxlength="4" value="0"/>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3 text-start" style="width: 40%;">
              <label for="saturationM" class="attached-text">Export Format (mp3 = audio only)</label>
              <div class="input-field-area">
                <div class="btn-group">
                  <button id="exportSelected" type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Extension</button>
                  <ul class="dropdown-menu" style="background-color: #0dcaf0; color: white;">
                    <li><a class="dropdown-item selectable-extension" href="#">.mp4</a></li>
                    <li><a class="dropdown-item selectable-extension" href="#">.mov</a></li>
                    <li><a class="dropdown-item selectable-extension" href="#">.mp3</a></li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5 w-0 visually-hidden" id="previewBox" style="background-color: #06091f; padding: 50px !important;">
        <h2>Video Preview</h2>

        <video id="video" controls class="visually-hidden mt-4 mb-4" style="width: 70%;"></video>

        <a href="#">
          <button type="button" class="btn btn-outline-info" id="sendAudioCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Modify video!
          </button>
        </a>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      // Sliders
      const speedSlider = document.getElementById("speedSlider");
      const speedDisplayValue = document.getElementById("speedDisplayValue");
      const scaleSlider = document.getElementById("scaleSlider");
      const scaleDisplayValue = document.getElementById("scaleDisplayValue");

      // Input Fields
      const startCrop = document.getElementById("startCropM");
      const endCrop = document.getElementById("endCropM");
      const startFade = document.getElementById("startFadeM");
      const endFade = document.getElementById("endFadeM");
      const exportSelected = document.getElementById("exportSelected");
      // /////////////////////////////////////////////////////////

      let videoDuration = undefined;
      let oldStart = 0;
      let oldEnd = 0;

      // APPLY LISTENERS
      speedSlider.addEventListener("change", function(){ speedDisplayValue.value = speedSlider.value; });
      scaleSlider.addEventListener("change", function(){ scaleDisplayValue.value = scaleSlider.value; });
      startCrop.addEventListener("input", modifyTime)
      endCrop.addEventListener("input", modifyTime)
      let selectors = document.getElementsByClassName("selectable-extension");
      for(let i = 0; i < selectors.length; i++)
        selectors[i].addEventListener("click", selectOption.bind(this, i))
      // //////////////////////////////////////////////////////////////////////////

      function modifyTime(){
        failed = false;
        if( parseInt(startCrop.value) > videoDuration || parseInt(startCrop.value) >= parseInt(endCrop.value) || parseInt(startCrop.value) < 0 || startCrop.value.includes("-") ){
          startCrop.value = oldStart;
          failed = true;
        }
        if( parseInt(endCrop.value) > videoDuration || parseInt(endCrop.value) <= parseInt(startCrop.value) || parseInt(endCrop.value) < 0 || endCrop.value.includes("-") ){
          endCrop.value = oldEnd;
          failed = true;
        }
        if(!failed){
          oldStart = startCrop.value;
          oldEnd = endCrop.value;
        }
      }

      function selectOption(order){
          exportSelected.innerText = selectors[order].innerText;
      }

      endCrop.addEventListener("input", function(){ if( parseInt(endCrop.value) > videoDuration ){endCrop.value = videoDuration} });
    </script>

    <script>
      const buttonCollapse = document.getElementsByClassName("field-button");
      const collapseElementList = document.querySelectorAll('.collapse');
      const collapseList = [...collapseElementList].map(collapseEl => new bootstrap.Collapse(collapseEl, { toggle: false }));
      for(let i = 0; i < buttonCollapse.length; i++)
        buttonCollapse[i].addEventListener("click", function(){ collapseList[i].toggle(); })
    </script>

    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const videoDisplay = document.getElementById("video");
      const uploadBox = document.getElementById("uploadBox");
      const previewBox = document.getElementById("previewBox");

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", loadVideoFile, false);

      videoDisplay.addEventListener('loadeddata', function() {
          if(videoDisplay.readyState >= 2) {
            videoDuration = Math.trunc(videoDisplay.duration);
            endCrop.value = videoDuration;
            endCrop.placeholder = videoDuration;
            displayElement(loader, false);
            displayElement(UID1, false);
            displayElement(UID2, true);
            displayElement(videoDisplay, true);
            uploadBox.classList.remove("col-xl-12")
            uploadBox.classList.add("col-xl-7")
            previewBox.classList.remove("w-0", "visually-hidden")
            videoDisplay.play();
          }
      });

      function loadVideoFile(){
        let videoFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        
        let videoObject = URL.createObjectURL(videoFile);
        videoDisplay.src = videoObject
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>

    <script>
      // Audio Communication - Server
      document.getElementById("sendAudioCall").addEventListener("click", sendAudioServer);

      function sendAudioServer(){
        let fileD = fileUpload.files[0];
        let formData = new FormData();
        formData.append("file", fileD);
        formData.append("startCrop", startCrop.value);
        formData.append("endCrop", endCrop.value);
        formData.append("fadeIn", startFade.value);
        formData.append("fadeOut", endFade.value);
        formData.append("duration", videoDuration);
        formData.append("speed", speedSlider.value);
        formData.append("scaling", scaleSlider.value);
        formData.append("extension", exportSelected.innerText == "Extension" ? "DEF" : exportSelected.innerText)

        // Send Request
        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", '/videoEditor', true);
        //httpRequest.setRequestHeader("Content-Type", "multipart/form-data");
        httpRequest.onreadystatechange = function(){ 
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                let jsonResponse = JSON.parse(this.responseText);
                let link = document.createElement("a");
                document.body.appendChild(link);
                link.setAttribute("type", "hidden");
                link.href = "data:text/plain;base64," + jsonResponse['videoFile'];
                link.download = "audioFile" + jsonResponse['extension'];
                link.click();
                document.body.removeChild(link);
                console.log("Terminated. Please, read from Server console to check the data sent.")
            }
        }
        httpRequest.send(formData);
      }
    </script>
</html>