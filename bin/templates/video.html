<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Video Editor</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="h-100 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | Video Editor
      </h2>
    </div>

    <div class="row m-0 text-center text-white border-top border-info" style="height: 90vh; width: 100vw;">
      <div class="col-xl-7">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload Video.</h1>
            <p class="lead">Upload your video file. The preview will be available on the right.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>Video Editor</h1>
            <p class="lead">Tweak any settings you want. Only the settings you modify will be applied.</p>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Video Cropping</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-2">Start</label>
                <input id="startTimeBox" placeholder="0" type="text" class="ms-2 me-4 under-line measure-v" maxlength="4"/>
                <label for="saturationM" class="ms-4 me-2">End</label>
                <input id="endTimeBox" placeholder="5" type="text" class="ms-2 under-line measure-v" maxlength="4"/>
              </div>
            </div>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Video Time</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-2">Start</label>
                <input id="startTimeBox" placeholder="0" type="text" class="ms-2 me-4 under-line measure-v" maxlength="4"/>
                <label for="saturationM" class="ms-4 me-2">End</label>
                <input id="endTimeBox" placeholder="5" type="text" class="ms-2 under-line measure-v" maxlength="4"/>
              </div>
            </div>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Fade Effect (in seconds)</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-2">Fade-in</label>
                <input id="startTimeBox" placeholder="0" type="text" class="ms-2 me-4 under-line measure-v" maxlength="4"/>
                <label for="saturationM" class="ms-4 me-2">Fade-out</label>
                <input id="endTimeBox" placeholder="5" type="text" class="ms-2 under-line measure-v" maxlength="4"/>
              </div>
            </div>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Video Speed</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">0.5</label>
                <input id="speedSlider" class="range-editor editor-b" type="range" min="0.5" max="2.5" step="0.25" value="1" id="speedM">
                <label for="saturationM" class="ms-4 me-2">2.5</label>
                <input id="speedDisplayValue" placeholder="1000" type="text" class="ms-4 under-line measure-v disabled-l" maxlength="4" value="1"/>
              </div>
            </div>
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Burn Subtitles</label>
              <div class="input-field-area">
                <input class="custom-file-input w-25 me-4" type="file" id="fileUpload">
                <label for="saturationM" class="ms-4 me-2">Adjust with speed changes</label>
                <label class="switch">
                  <input id="enableExtractM" type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>
            <div class="mb-3 text-start" style="width: 40%;">
              <label for="saturationM" class="attached-text">Export Format</label>
              <div class="input-field-area">
                <div class="btn-group">
                  <button id="exportSelected" type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Extension
                  </button>
                  <ul class="dropdown-menu" style="background-color: #0dcaf0; color: white;">
                    <li><a class="dropdown-item selectable-extension" href="#">.mp4</a></li>
                    <li><a class="dropdown-item selectable-extension" href="#">.mov</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5" id="containingBox" style="background-color: #06091f; padding: 50px !important;">
        <h2>Video Preview</h2>

        <video id="video" controls class="visually-hidden mt-4 mb-4" style="width: 70%;"></video>

        <a href="#">
          <button type="button" class="btn btn-outline-info" id="sendAudioCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Modify video!
          </button>
        </a>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      const speedSlider = document.getElementById("speedSlider");
      const speedDisplayValue = document.getElementById("speedDisplayValue")

      // APPLY LISTENERS
      speedSlider.addEventListener("change", updateSpeed);
      // //////////////////////////////////////////////////////////////////////////
      
      function updateSpeed(){
        speedDisplayValue.value = speedSlider.value;
      }
    </script>

    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const videoDisplay = document.getElementById("video")

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", loadVideoFile, false);

      let videoDuration = 0;

      videoDisplay.addEventListener('loadeddata', function() {
          if(videoDisplay.readyState >= 2) {
            displayElement(loader, false);
            displayElement(UID1, false);
            displayElement(UID2, true);
            displayElement(videoDisplay, true);
            videoDuration = Math.trunc(videoDisplay.duration);
            videoDisplay.play();
          }
      });

      function loadVideoFile(){
        let videoFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        
        let videoObject = URL.createObjectURL(videoFile);
        videoDisplay.src = videoObject
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>

    <script>
      // Audio Communication - Server
      document.getElementById("sendAudioCall").addEventListener("click", sendAudioServer);

      function sendAudioServer(){
        let fileD = fileUpload.files[0];
        let formData = new FormData();
        formData.append("file", fileD);
        formData.append("variableHere", "HelloWorld!")

        // Send Request
        var httpRequest = new XMLHttpRequest();
        httpRequest.open("POST", '/videoEditor', true);
        //httpRequest.setRequestHeader("Content-Type", "multipart/form-data");
        httpRequest.onreadystatechange = function(){ 
            if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                let jsonResponse = JSON.parse(this.responseText);
                let link = document.createElement("a");
                document.body.appendChild(link);
                link.setAttribute("type", "hidden");
                link.href = "data:text/plain;base64," + jsonResponse['musicFile'];
                link.download = "audioFile" + jsonResponse['extension'];
                link.click();
                document.body.removeChild(link);
                console.log("Terminated. Please, read from Server console to check the data sent.")
            }
        }
        httpRequest.send(formData);
      }
    </script>
</html>