<!DOCTYPE html>
<html class="h-100 w-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Image Editor</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="row w-100 h-100 m-0 interactive-bg">
    <div class="d-flex align-items-center justify-content-center text-white interactive-bg p-0 m-0" style="height: 10vh;">
      <h2>
          <i class="bi bi-disc"></i>
          AudioCanary | Image Editor
      </h2>
    </div>

    <div class="row p-0 m-0 text-center text-white border-top border-info w-100" style="height: 90vh">
      <div class="col-xl-7">
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column align-items-center justify-content-center">
          <div id="mainBox">
            <h1>Upload Image.</h1>
            <p class="lead">Try uploading an image and see how the server responds.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden" style="width: 80%;">
            <h1>Image Effects</h1>

            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Brightness</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">-100</label>
                <input class="range-editor editor-b" type="range" min="-100" max="100" step="1" value="0" id="brightnessM">
                <label for="saturationM" class="ms-4">100</label>
                <input placeholder="0" type="text" class="ms-4 under-line" maxlength="3"/>
              </div>
            </div> 
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Contrast</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">-100</label>
                <input class="range-editor editor-b" type="range" min="-100" max="100" step="1" value="0" id="contrastM">
                <label for="saturationM" class="ms-4">100</label>
                <input placeholder="0" type="text" class="ms-4 under-line" maxlength="3"/>
              </div>
            </div> 
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Saturation</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">-100</label>
                <input class="range-editor editor-b" type="range" min="-100" max="100" step="1" value="0" id="saturationM">
                <label for="saturationM" class="ms-4">100</label>
                <input placeholder="0" type="text" class="ms-4 under-line" maxlength="3"/>
              </div>
            </div> 
            <div class="mb-3 text-start">
              <label for="saturationM" class="attached-text">Sharpness</label>
              <div class="input-field-area">
                <label for="saturationM" class="me-4">0</label>
                <input class="range-editor editor-b" type="range" min="0" max="15" step="1" value="0" id="sharpnessM">
                <label for="saturationM" class="ms-4">15</label>
                <input placeholder="0" type="text" class="ms-4 under-line" maxlength="2"/>
              </div>
            </div>
            
            <div class="mb-3 text-start" style="width: 50%;">
              <label for="saturationM" class="attached-text">Custom Filters</label>
              <div class="input-field-area d-flex justify-content-between">
                <label for="saturationM" class="me-4 fs-5">Grayscale</label>
                <label class="switch">
                  <input type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div> 

            <div class="mb-3 text-start" style="width: 50%;">
              <div class="input-field-area d-flex justify-content-between">
                <label for="saturationM" class="me-1 fs-5">Threshold</label>
                <input value="75" type="text" class="me-3 ms-2 another-line disabled-l threshold-var" maxlength="3"/>
                <label class="switch">
                  <input type="checkbox" class="check-filter">
                  <span class="slider round"></span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-column justify-content-center align-items-center col-xl-5" id="containingBox" style="background-color: #06091f; padding: 50px !important;">
        <img id="imageDisplay" src="#" alt="Preview Image" class="visually-hidden m-auto" style="height: 60vh;"/>
        <h2>Image Preview</h2>
        <div class="mt-4 mb-4" style="width: 400px; height: 400px; background-color: black; display: flex;">
          <canvas width="500" height="500" id="canvas" class="visually-hidden m-auto"/>
        </div>
        <a href="#">
          <button type="button" class="btn btn-outline-info" id="storeImageCall">
            <span class="loading-save spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
            Save Image
          </button>
        </a>
        <canvas width="500" height="500" id="realCanvas" class="visually-hidden"/>
        <a id="downloadLink" class="visually-hidden"></a>
      </div>
    </div>
  </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const imageDisplay = document.getElementById("imageDisplay");
      const canvasObject = document.getElementById("canvas");
      const canvasContext = canvasObject.getContext('2d');

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      fileUpload.addEventListener("change", displayImage, false);

      let imageWidth = 0;
      let imageHeight = 0;

      function displayImage(){
        let imageFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        console.log("The file name is: " + imageFile.name)
        console.log("The file size is: " + imageFile.size + " bytes.")
        
        let imageObject = new Image;
        imageObject.onload = function(){
            determineCanvasDimension(imageObject.width, imageObject.height)
            canvasContext.drawImage(imageObject, 0, 0, canvasObject.width, canvasObject.height);
            displayElement(loader, false);
            displayElement(canvasObject, true);
            displayElement(UID1, false);
            displayElement(UID2, true);
        }
        imageObject.src = URL.createObjectURL(imageFile);
      }

      function determineCanvasDimension(width, height){
        let maxWidth = 400;
        let maxHeight = 400;
        let ratio = width / (height * 1.0);

        if(width > height){
          if(width > maxWidth){
            canvasObject.width = maxWidth;
            canvasObject.height = maxWidth / ratio;
          }
          else{
            canvasObject.width = width;
            canvasObject.height = canvasObject.width / ratio;
          }
        }
        else{
          if(height > maxHeight){
            canvasObject.height = maxHeight;
            canvasObject.width = maxHeight * ratio;
          }
          else{
            canvasObject.height = height;
            canvasObject.width = canvasObject.height * ratio;
          }
        }

        // Assign for global use
        imageWidth = width;
        imageHeight = height;
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }

      function enableElement(element, enable){
        if(enable)
          element.classList.remove("disabled-l");
        else
          element.classList.add("disabled-l");
      }
    </script>
    
    <script type="text/javascript" src="{{ url_for('static', filename='caman.full.min.js') }}"></script>

    <script>
      // Editor
      const editorBs = document.getElementsByClassName("editor-b");
      const inputs = document.getElementsByClassName("under-line");
      const filters = document.getElementsByClassName("check-filter");
      const thresholdInput = document.getElementsByClassName("threshold-var")[0];
      for(let i = 0; i < editorBs.length; i++){
        editorBs[i].addEventListener("change", executeChanges);
        editorBs[i].addEventListener("change", applyChange.bind(this, i));
        inputs[i].addEventListener("input", alternativeInput.bind(this, i));
      }
      for(let i = 0; i < filters.length; i++)
        filters[i].addEventListener("change", filterTriggered.bind(this, i));
      thresholdInput.addEventListener("input", executeChanges);
      document.getElementById("storeImageCall").addEventListener("click", storeImage);
      // ////////////////////////////////////////////////////////////////

      // Sliders
      const brightnessO = document.getElementById("brightnessM");
      const contrastO = document.getElementById("contrastM");
      const saturationO = document.getElementById("saturationM");
      const sharpnessO = document.getElementById("sharpnessM");
      let filterSet = null;
      // ////////////////////////////////////////////////////////////////


      // Give in the Filters to Caman
      Caman.Filter.register("threshold", function (limit){
          this.process("threshold", function (rgba) {
              var lumin = (0.2126 * rgba.r) + (0.7152 * rgba.g) + (0.0722 * rgba.b);
              rgba.r = lumin > limit ? 255 : 0;
              rgba.g = lumin > limit ? 255 : 0;
              rgba.b = lumin > limit ? 255 : 0;
          });
          return this;
      });

      Caman.Filter.register("grayscale", function () {
          this.process("grayscale", function (rgba) {
              var lumin = (0.2126 * rgba.r) + (0.7152 * rgba.g) + (0.0722 * rgba.b);
              rgba.r = lumin;
              rgba.g = lumin;
              rgba.b = lumin;
          });
          return this;
      });
      // /////////////////////////////////////////////////////////////////////////////
      

      function executeChanges(){
        Caman("#canvas", function(){
          this.revert(false);

          if( filterSet == null ){
            if( parseInt(brightnessO.value) !== 0)
              this.brightness( parseInt(brightnessO.value) );
            if( parseInt(contrastO.value) !== 0 )
              this.contrast( parseInt(contrastO.value) );
            if( parseInt(saturationO.value) !== 0 )
              this.saturation( parseInt(saturationO.value) );
            if( parseInt(sharpnessO.value) !== 0 )
              this.sharpen( parseInt(sharpnessO.value) );
          }
          else{
            if( filterSet == 0 )
              this.grayscale();
            if( filterSet == 1 )
              this.threshold(thresholdInput.value);
          }
          
          this.render();
        });
      }

      function applyChange(elementNum){
        inputs[elementNum].value = editorBs[elementNum].value;
      }

      function alternativeInput(elementNum){
        editorBs[elementNum].value = inputs[elementNum].value;
        executeChanges();
      }

      function filterTriggered(elementNum){
        filterSet = filters[elementNum].checked ? elementNum : null;
        for(let i = 0; i < editorBs.length; i++){
          enableElement(editorBs[i], !filters[elementNum].checked);
          enableElement(inputs[i], !filters[elementNum].checked)
        }
        for(let i = 0; i < filters.length; i++){
          if(i !== elementNum){
            enableElement(filters[i], !filters[elementNum].checked)
            filters[i].checked = false;
          }
          
        }
        if(elementNum === 1)
            enableElement(thresholdInput, filters[elementNum].checked)
        executeChanges();
      }

      function storeImage(){
        displayElement(document.getElementsByClassName("loading-save")[0], true);
        document.getElementById("storeImageCall").classList.add("disabled");

        // Use the Real Canvas to work on the image
        let realCanvas = document.getElementById("realCanvas");
        let realContext = realCanvas.getContext('2d');
        let imageFile = fileUpload.files[0];
        let imageObject = new Image;
        imageObject.onload = function(){
            realCanvas.width = imageObject.width;
            realCanvas.height = imageObject.height;
            realContext.drawImage(imageObject, 0, 0, realCanvas.width, realCanvas.height);
            
            Caman("#realCanvas", function(){
              if( filterSet == null ){
                if( parseInt(brightnessO.value) !== 0)
                  this.brightness( parseInt(brightnessO.value) );
                if( parseInt(contrastO.value) !== 0 )
                  this.contrast( parseInt(contrastO.value) );
                if( parseInt(saturationO.value) !== 0 )
                  this.saturation( parseInt(saturationO.value) );
                if( parseInt(sharpnessO.value) !== 0 )
                  this.sharpen( parseInt(sharpnessO.value) );
              }
              else{
                if( filterSet == 0 )
                  this.grayscale();
                if( filterSet == 1 )
                  this.threshold(thresholdInput.value);
              }
              
              this.render( function(){
                let link = document.getElementById('downloadLink');
                link.setAttribute('download', 'EditedImage.png');
                link.setAttribute('href', realCanvas.toDataURL("image/png", 0.5).replace("image/png", "image/octet-stream"));

                displayElement(document.getElementsByClassName("loading-save")[0], false);
                document.getElementById("storeImageCall").classList.remove("disabled");
                link.click();
              } );
            });
        }
        imageObject.src = URL.createObjectURL(imageFile);

        // ////////////////////////////////////////
      }
    </script>
</html>