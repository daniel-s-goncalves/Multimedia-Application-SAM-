<!DOCTYPE html>
<html class="h-100">

  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>SAM | Image Editor</title>
      <!-- Bootstrap core CSS -->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
      <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
      <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  </head>

  <body class="d-flex h-100 text-center text-white bg-dark">
      <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
        <header class="mb-auto text-center">
          <h3>Image Editor</h3>
        </header>
      
        <main class="px-3">
          <div id="mainBox">
            <h1>Upload Image.</h1>
            <p class="lead">Try uploading an image and see how the server responds.</p>
            <div class="mb-3">
              <input class="form-control" style="width: 50%; margin: auto;" type="file" id="fileUpload">
              <div id="loadingView" class="spinner-border visually-hidden" role="status"></div>
            </div>
          </div>

          <div id="editBox" class="visually-hidden">
            <h1>Image uploaded</h1>
            <p class="lead">Please, tweak the settings bellow.</p>
            <div class="row mb-3 text-start">
              <label for="saturationM" class="form-label mb-1">Brightness</label>
              <input type="range" class="form-range editor-b" min="-100" max="100" step="1" id="brightnessM">
            </div> 
            <div class="row mb-3 text-start mt-4">
              <label for="contrastM" class="form-label mb-1">Contrast</label>
              <input type="range" class="form-range editor-b" min="-100" max="100" step="1" id="contrastM">
            </div>
            <div class="row mb-3 text-start">
                <label for="saturationM" class="form-label mb-1">Saturation</label>
                <input type="range" class="form-range editor-b" min="-100" max="100" step="1" id="saturationM">
            </div> 
            <div class="row mb-3 text-start">
              <label for="saturationM" class="form-label mb-1">Sharpness</label>
              <input type="range" class="form-range editor-b" min="-100" max="100" step="1" id="sharpnessM">
            </div>
          </div>
        </main>
      
        <footer class="mt-auto text-white-50">
          <p>SAM | FEUP | 2022</p>
        </footer>
      </div>
      <img id="imageDisplay" src="#" alt="Preview Image" class="visually-hidden m-auto" style="height: 60vh;"/>
      <canvas width="400" height="300" id="canvas" class="visually-hidden m-auto"/>
    </body>
  
    <script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>
  
    <script>
      const fileUpload = document.getElementById("fileUpload");
      const loader = document.getElementById("loadingView");
      const imageDisplay = document.getElementById("imageDisplay");
      const canvasObject = document.getElementById("canvas");
      const canvasContext = canvasObject.getContext('2d');

      const UID1 = document.getElementById("mainBox");
      const UID2 = document.getElementById("editBox");
      let defaultImageData = new ImageData(2,2);
      fileUpload.addEventListener("change", displayImage, false);

      function displayImage(){
        let imageFile = this.files[0];
        displayElement(fileUpload, false)
        displayElement(loader, true)
        console.log("The file name is: " + imageFile.name)
        console.log("The file size is: " + imageFile.size + " bytes.")
        
        let imageObject = new Image;
        imageObject.onload = function(){
            canvasContext.drawImage(imageObject,0,0);
            displayElement(loader, false)
            displayElement(canvasObject, true)
            displayElement(UID1, false)
            displayElement(UID2, true)
            defaultImageData = canvasContext.getImageData(0, 0, 400, 300);
        }
        imageObject.src = URL.createObjectURL(imageFile);
      }

      function displayElement(element, showOnScreen){
        if(showOnScreen)
          element.classList.remove("visually-hidden");
        else
          element.classList.add("visually-hidden");
      }
    </script>
    
    <script type="text/javascript" src="{{ url_for('static', filename='caman.full.min.js') }}"></script>

    <script>
      // Editor
      const editorBs = document.getElementsByClassName("editor-b")
      for(let i = 0; i < editorBs.length; i++)
        editorBs[i].addEventListener("change", executeChanges)
      // ////////////////////////////////////////////////////////////////

      // Sliders
      const brightnessO = document.getElementById("brightnessM");
      const contrastO = document.getElementById("contrastM");
      const saturationO = document.getElementById("saturationM");
      const sharpnessO = document.getElementById("sharpnessM");
      // ////////////////////////////////////////////////////////////////


      // Image Object
      let canvasImgData = undefined;
      // ///////////////////////////////////////////////////////////////
      function executeChanges(){
        /*// Set-Up default Image Data - Deep copy
        canvasImgData = canvasContext.getImageData(0, 0, 400, 300);
        copyImageData(defaultImageData, canvasImgData);

        changeContrast(contrastO.value);
        canvasContext.putImageData(canvasImgData, 0, 0);*/

      }

      function changeContrast(value){
        let data = canvasImgData.data;
        value = (value / 100) + 1;  // Convert to decimal & shift range: [0..2]
        let intercept = 128 * (1 - value);
        for(let i = 0; i < data.length; i += 4){   //r,g,b,a
            data[i] = data[i] * value + intercept;
            data[i+1] = data[i+1] * value + intercept;
            data[i+2] = data[i+2] * value + intercept;
        }
      }

      function changeBrightness(value){
        return true;
      }

      function copyImageData(sourceData, destData){
        if( !(sourceData.width == destData.width && sourceData.height == destData.height) ){
          console.error("This method was called, but both ImageDatas have different types.")
          return;
        }

        for(let i = 0; i < sourceData.data.length; i += 4){
            destData.data[i] = sourceData.data[i];
            destData.data[i+1] = sourceData.data[i+1];
            destData.data[i+2] = sourceData.data[i+2];
            destData.data[i+3] = sourceData.data[i+3];
        }
      }

      /*
        Caman("#canvas", function(){
          this.revert(false);
          this.brightness( brightnessO.value );
          this.contrast( contrastO.value );
          this.saturation( saturationO.value );
          this.render();
        });*/
      
    </script>
</html>